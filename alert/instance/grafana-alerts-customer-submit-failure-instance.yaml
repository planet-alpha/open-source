# Grafana 客户提交失败率告警配置 (Prometheus 数据源)
# 仅保留信息级 5 分钟失败率规则（InfoShort）

apiVersion: 1

groups:
  - orgId: 1
    name: Customer Submit Failure Alerts
    folder: Business-Latency
    interval: 1m
    rules:
      # 失败率（信息级）- 短窗口 5 分钟用于快速捕捉异常升高，带短窗基线
      - uid: customer_submit_failure_rate_info_short
        title: CustomerSubmitFailureRateInfoShort
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                (
                  (
                    sum by(name, appName,cId,appId)(
                      increase(customer_submit_total{cId=~".*", name=~".*", appId=~".*", appName=~".*", stat!="0"}[5m])
                    )
                    /
                    sum by(name, appName,cId,appId)(
                      increase(customer_submit_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m])
                    )
                  ) > 0.02
                )
                and
                (
                  sum by(name, appName,cId,appId)(
                    increase(customer_submit_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m])
                  ) >= 50
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "客户名称:{{name}} 客户id :{{cId}} 客户应用名称:{{appName}} 客户应用id:{{appId}} | failure_rate_info_5m"
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: ""
              type: reduce
              refId: B
          - refId: C
            relativeTimeRange:
              from: 300
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [B]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 0m
        annotations:
          summary: "客户提交失败率在5分钟窗口内上升 (客户名称:{{ $labels.name }} 客户id :{{ $labels.cId }} 客户应用名称:{{ $labels.appName }} 客户应用id:{{ $labels.appId }})"
          description: |
            基于过去 5 分钟数据，检测到提交失败率超过 2%（且 5 分钟提交总量 ≥ 50）。
            该级别用于快速提示短时异常，便于及时关注。
        labels:
          severity: info
          category: submit
          alert_type: submit_failure_rate_info_5m
