# Grafana 客户登陆失败突增告警配置 (Prometheus 数据源)
# 使用说明：
# 1) 将 P1809F7CD0C75ACF3 替换为你的 Prometheus 数据源 UID（Grafana -> 数据源 -> Prometheus -> UID）
# 2) 将本文件放到 Grafana provisioning 目录（如 /etc/grafana/provisioning/alerting/），并重启/重新加载 Grafana
# 3) 告警会出现在 "Business-Customer-Login" 文件夹下
# 4) 环境变量（可在 Grafana 中设置或直接替换本文内变量）：
#    - EVAL_FROM_SECONDS：评估回看秒数（默认：1800，即30分钟）
#    - FOR_DURATION：告警持续判定时长（默认：2m）
#    - MIN_BASELINE_TOTAL：基线总量阈值（过去30m内1m总登陆量的均值），低于该值不触发（默认：50）
#    - MIN_ABS_FAIL：绝对失败阈值（当前2m失败数），默认：10
#    - FAIL_SURGE_PCT_THRESHOLD：失败突增比例阈值(%)，默认：50（表示相对30m基线增长≥50%触发）
#    - FAIL_RATE_THRESHOLD：失败率阈值(%)，默认：10（失败率超过10%时触发）
# 说明：
# - 监控reason字段不为"连接成功"的所有情况为失败
# - 采用过去30分钟的平均失败率作为动态基线，检测突然增大的情况
# - 同时监控2分钟内的增长幅度和绝对失败数量
# - 设置总量基线避免低流量时的误报

apiVersion: 1

groups:
  - orgId: 1
    name: Customer Login Failure Surge Alerts
    folder: Business-Customer-Login
    interval: 1m
    rules:
      # Rule 1: 客户登陆失败突增告警（相对30分钟基线）
      - uid: customer_login_failure_surge_baseline
        title: CustomerLoginFailureSurgeBaseline
        condition: C
        data:
          # A: 失败突增比例(%)，相对30m动态基线
          - refId: A
            relativeTimeRange:
              from: 1800
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                # 计算失败突增比例(%)，相对30m动态基线
                clamp_min(
                  (
                    # F_cur: 当前2m失败率(%)
                    100 * (
                      sum by(appId)(increase(customer_login_total{appId=~".*", reason!="连接成功"}[2m]))
                      /
                      clamp_min(sum by(appId)(increase(customer_login_total{appId=~".*"}[2m])), 1)
                    )
                    
                    -
                    
                    # F_base: 30m基线失败率(%)
                    100 * avg_over_time((
                      sum by(appId)(increase(customer_login_total{appId=~".*", reason!="连接成功"}[1m]))
                      /
                      clamp_min(sum by(appId)(increase(customer_login_total{appId=~".*"}[1m])), 1)
                    )[30m:1m])
                  )
                  /
                  # 除以基线失败率，得到相对增长比例
                  clamp_min(100 * avg_over_time((
                    sum by(appId)(increase(customer_login_total{appId=~".*", reason!="连接成功"}[1m]))
                    /
                    clamp_min(sum by(appId)(increase(customer_login_total{appId=~".*"}[1m])), 1)
                  )[30m:1m]), 0.1)
                  * 100, 0
                )
                and (
                  # 绝对失败门槛：当前2m失败数 >= MIN_ABS_FAIL
                  sum by(appId)(increase(customer_login_total{appId=~".*", reason!="连接成功"}[2m])) >= 10
                )
                and (
                  # 总量基线门槛：30m内1m总登陆量的均值 >= MIN_BASELINE_TOTAL
                  avg_over_time(sum by(appId)(increase(customer_login_total{appId=~".*"}[1m]))[30m:1m]) >= 50
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "{{appId}} 当前失败突增比例(%)"
              instant: true
              range: false
              refId: A
          
          # C: 阈值判断——当突增比例 ≥ FAIL_SURGE_PCT_THRESHOLD 触发
          - refId: C
            relativeTimeRange:
              from: 1800
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [50]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: "客户{{ $labels.appId }}登陆失败突增（相对30m基线）"
          description: |
            客户登陆失败率相对30分钟基线突然增长 ≥ 50%
        labels:
          severity: warning
          category: business-customer-login
          alert_type: failure_surge_baseline

      # Rule 2: 客户登陆失败率绝对阈值告警
      - uid: customer_login_failure_rate_high
        title: CustomerLoginFailureRateHigh
        condition: C
        data:
          # A: 当前2分钟失败率
          - refId: A
            relativeTimeRange:
              from: 240   # 4分钟
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                # 当前2m失败率(%)
                100 * (
                  sum by(appId)(increase(customer_login_total{appId=~".*", reason!="连接成功"}[2m]))
                  /
                  clamp_min(sum by(appId)(increase(customer_login_total{appId=~".*"}[2m])), 1)
                )
                and (
                  # 绝对失败门槛：当前2m失败数 >= MIN_ABS_FAIL
                  sum by(appId)(increase(customer_login_total{appId=~".*", reason!="连接成功"}[2m])) >= 10
                )
                and (
                  # 总量门槛：当前2m总登陆数 >= MIN_BASELINE_TOTAL/2
                  sum by(appId)(increase(customer_login_total{appId=~".*"}[2m])) >= 50/2
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "{{appId}} 当前失败率(%)"
              instant: true
              range: false
              refId: A
          
          # C: 阈值判断——当失败率 ≥ FAIL_RATE_THRESHOLD 触发
          - refId: C
            relativeTimeRange:
              from: 240
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [10]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: "客户{{ $labels.appId }}登陆失败率过高"
          description: |
            客户登陆失败率超过阈值 10%
        labels:
          severity: critical
          category: business-customer-login
          alert_type: failure_rate_high

      # Rule 3: 客户登陆失败数绝对突增告警（2分钟 vs 30分钟均值）
      - uid: customer_login_failure_absolute_surge
        title: CustomerLoginFailureAbsoluteSurge
        condition: C
        data:
          # A: 失败数绝对突增量
          - refId: A
            relativeTimeRange:
              from: 1800
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                # 失败数绝对突增量：当前2m失败数 - 30m内2m失败数均值
                (
                  sum by(appId)(increase(customer_login_total{appId=~".*", reason!="连接成功"}[2m]))
                  -
                  2 * avg_over_time(sum by(appId)(increase(customer_login_total{appId=~".*", reason!="连接成功"}[1m]))[30m:1m])
                )
                and (
                  # 当前2m失败数 >= MIN_ABS_FAIL
                  sum by(appId)(increase(customer_login_total{appId=~".*", reason!="连接成功"}[2m])) >= 10
                )
                and (
                  # 30m内1m总登陆量的均值 >= MIN_BASELINE_TOTAL
                  avg_over_time(sum by(appId)(increase(customer_login_total{appId=~".*"}[1m]))[30m:1m]) >= 50
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "{{appId}} 当前登陆失败数"
              instant: true
              range: false
              refId: A
          
          # C: 阈值判断——当绝对突增量 ≥ MIN_ABS_FAIL 触发
          - refId: C
            relativeTimeRange:
              from: 1800
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [10]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 2m
        annotations:
          summary: "客户{{ $labels.appId }}登陆失败数绝对突增"
          description: |
            客户登陆失败数相对30分钟均值出现绝对突增 ≥ 10
        labels:
          severity: warning
          category: business-customer-login
          alert_type: failure_absolute_surge
