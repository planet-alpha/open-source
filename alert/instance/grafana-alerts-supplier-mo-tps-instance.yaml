# Grafana 供应商侧上行（MO）TPS 多级告警（Prometheus 数据源）
# 使用说明：
# 1) 本文件已将数据源 UID 设置为 P1809F7CD0C75ACF3（与供应商侧 TPS 激增配置保持一致）。如需调整，请替换 datasourceUid/uid 字段。
# 2) 将文件放到 Grafana provisioning/alerting 目录并重启/重新加载 Grafana
# 3) 告警会出现在 "Business-Supplier-MO-TPS" 文件夹下
# 4) 可通过环境变量调整阈值（以下为默认值）：
#    - WINDOW：平滑窗口，默认 5m
#    - EVAL_FROM_SECONDS：评估回看秒数，默认 600（10 分钟）
#    - SURGE_MULTIPLIER_WARN/HIGH/CRIT：激增倍率阈值，默认 2/3/5
#    - SURGE_ABSOLUTE_TPS_WARN/HIGH/CRIT：激增绝对 TPS 阈值，默认 10/20/50
#    - DROP_MULTIPLIER_WARN/HIGH/CRIT：骤降倍率阈值，默认 0.5/0.3/0.1
#    - BASELINE_MIN_TPS：基线最低 TPS（骤降需满足），默认 5
#    - FOR_WARN_SURGE/FOR_HIGH_SURGE/FOR_CRIT_SURGE：激增 for 时长，默认 3m/5m/5m
#    - FOR_WARN_DROP/FOR_HIGH_DROP/FOR_CRIT_DROP：骤降 for 时长，默认 5m/10m/15m

apiVersion: 1

groups:
  - orgId: 1
    name: Supplier MO TPS Alerts
    folder: Business-Supplier-MO-TPS
    interval: 1m
    rules:
      # ======================= 激增(WARNING) =======================
      - uid: supplier_mo_tps_surge_warning
        title: SupplierMoTpsSurge(Warning)
        condition: D
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m]))
                >
                bool
                2
                *
                sum by(name, appName)(avg_over_time(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m])[1h:5m]))
              interval: ""
              intervalMs: 1000
              legendFormat: "MO TPS 激增(Warning) - 倍率"
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m]))
                >
                bool
                10
              interval: ""
              intervalMs: 1000
              legendFormat: "MO TPS 激增(Warning) - 绝对值"
              maxDataPoints: 43200
              range: true
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource: { type: __expr__, uid: __expr__ }
              expression: A
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: reduce
          - refId: E
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource: { type: __expr__, uid: __expr__ }
              expression: B
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: E
              type: reduce
          - refId: R
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m]))
              interval: ""
              intervalMs: 1000
              legendFormat: "{{name}}-{{appName}} 当前MO TPS"
              maxDataPoints: 43200
              range: true
              refId: R
          - refId: T
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(avg_over_time(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m])[1h:5m]))
              interval: ""
              intervalMs: 1000
              legendFormat: "{{name}}-{{appName}} 1h基线MO TPS"
              maxDataPoints: 43200
              range: true
              refId: T
          - refId: RR
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: R
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: RR
              type: reduce
          - refId: TT
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: T
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: TT
              type: reduce
          - refId: F
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource: { type: __expr__, uid: __expr__ }
              expression: $C * $E
              intervalMs: 1000
              maxDataPoints: 43200
              refId: F
              type: math
          - refId: D
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator: { params: [0], type: gt }
                  operator: { type: and }
                  query: { params: [F] }
                  reducer: { type: last }
                  type: query
              datasource: { type: __expr__, uid: __expr__ }
              expression: F
              intervalMs: 1000
              maxDataPoints: 43200
              refId: D
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 3m
        annotations:
          summary: MO TPS 激增(Warning) - 供应商：{{ $labels.name }}/{{ $labels.appName }}
          description: |
            当前 5m TPS 明显高于 1h 基线。
            当前值: {{ $values.RR.Value | printf "%.2f" }} TPS，基线: {{ $values.TT.Value | printf "%.2f" }} TPS。
            条件：倍率 ≥ 2 且 绝对TPS > 10 TPS，持续 3m。
        labels:
          severity: warning
          category: business-supplier-mo-tps
          alert_type: tps_surge

      # ======================= 激增(HIGH) =======================
      - uid: supplier_mo_tps_surge_high
        title: SupplierMoTpsSurge(High)
        condition: D
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m]))
                >
                bool
                3
                *
                sum by(name, appName)(avg_over_time(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m])[1h:5m]))
              interval: ""
              intervalMs: 1000
              legendFormat: "MO TPS 激增(High) - 倍率"
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m]))
                >
                bool
                20
              interval: ""
              intervalMs: 1000
              legendFormat: "MO TPS 激增(High) - 绝对值"
              maxDataPoints: 43200
              range: true
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource: { type: __expr__, uid: __expr__ }
              expression: A
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: reduce
          - refId: E
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource: { type: __expr__, uid: __expr__ }
              expression: B
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: E
              type: reduce
          - refId: R
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m]))
              interval: ""
              intervalMs: 1000
              legendFormat: "{{name}}-{{appName}} 5m窗口MO TPS"
              maxDataPoints: 43200
              range: true
              refId: R
          - refId: T
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(avg_over_time(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m])[1h:5m]))
              interval: ""
              intervalMs: 1000
              legendFormat: "{{name}}-{{appName}} 1h基线MO TPS"
              maxDataPoints: 43200
              range: true
              refId: T
          - refId: RR
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: R
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: RR
              type: reduce
          - refId: TT
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: T
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: TT
              type: reduce
          - refId: F
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource: { type: __expr__, uid: __expr__ }
              expression: $C * $E
              intervalMs: 1000
              maxDataPoints: 43200
              refId: F
              type: math
          - refId: D
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator: { params: [0], type: gt }
                  operator: { type: and }
                  query: { params: [F] }
                  reducer: { type: last }
                  type: query
              datasource: { type: __expr__, uid: __expr__ }
              expression: F
              intervalMs: 1000
              maxDataPoints: 43200
              refId: D
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: MO TPS 激增(High) - 供应商：{{ $labels.name }}/{{ $labels.appName }}
          description: |
            当前 5m TPS 显著高于 1h 基线。
            当前值: {{ $values.RR.Value | printf "%.2f" }} TPS，基线: {{ $values.TT.Value | printf "%.2f" }} TPS。
            条件：倍率 ≥ 3 且 绝对TPS > 20 TPS，持续 5m。
        labels:
          severity: high
          category: business-supplier-mo-tps
          alert_type: tps_surge

      # ======================= 激增(CRITICAL) =======================
      - uid: supplier_mo_tps_surge_critical
        title: SupplierMoTpsSurge(Critical)
        condition: D
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m]))
                >
                bool
                5
                *
                sum by(name, appName)(avg_over_time(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m])[1h:5m]))
              interval: ""
              intervalMs: 1000
              legendFormat: "MO TPS 激增(Critical) - 倍率"
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m]))
                >
                bool
                50
              interval: ""
              intervalMs: 1000
              legendFormat: "MO TPS 激增(Critical) - 绝对值"
              maxDataPoints: 43200
              range: true
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource: { type: __expr__, uid: __expr__ }
              expression: A
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: reduce
          - refId: E
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource: { type: __expr__, uid: __expr__ }
              expression: B
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: E
              type: reduce
          - refId: R
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m]))
              interval: ""
              intervalMs: 1000
              legendFormat: "{{name}}-{{appName}} 5m窗口MO TPS"
              maxDataPoints: 43200
              range: true
              refId: R
          - refId: T
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName)(avg_over_time(rate(supplier_mo_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m])[1h:5m]))
              interval: ""
              intervalMs: 1000
              legendFormat: "{{name}}-{{appName}} 1h基线MO TPS"
              maxDataPoints: 43200
              range: true
              refId: T
          - refId: RR
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: R
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: RR
              type: reduce
          - refId: TT
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: T
              reducer: last
              intervalMs: 1000
              maxDataPoints: 43200
              refId: TT
              type: reduce
          - refId: F
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource: { type: __expr__, uid: __expr__ }
              expression: $C * $E
              intervalMs: 1000
              maxDataPoints: 43200
              refId: F
              type: math
          - refId: D
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator: { params: [0], type: gt }
                  operator: { type: and }
                  query: { params: [F] }
                  reducer: { type: last }
                  type: query
              datasource: { type: __expr__, uid: __expr__ }
              expression: F
              intervalMs: 1000
              maxDataPoints: 43200
              refId: D
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: MO TPS 激增(Critical) - 供应商：{{ $labels.name }}/{{ $labels.appName }}
          description: |
            当前 5m TPS 远高于 1h 基线。
            当前值: {{ $values.RR.Value | printf "%.2f" }} TPS，基线: {{ $values.TT.Value | printf "%.2f" }} TPS。
            条件：倍率 ≥ 5 且 绝对TPS > 50 TPS，持续 5m。
        labels:
          severity: critical
          category: business-supplier-mo-tps
          alert_type: tps_surge
