# Grafana 上行（MO）TPS 异常告警配置（Prometheus 数据源）
# 说明：
# 1) 将 P1809F7CD0C75ACF3 替换为你的 Prometheus 数据源 UID
# 2) 将本文件放到 Grafana provisioning 目录（如 /etc/grafana/provisioning/alerting/），并重启/重新加载 Grafana
# 3) 告警会出现在 "Business-MO-TPS" 文件夹下
# 4) 环境变量：
#    - WINDOW：平滑监控窗口，默认 5m
#    - EVAL_FROM_SECONDS：评估回看秒数（默认：600 秒）
#    - FOR_DURATION：告警持续判定时长（默认：5m）
#    - SURGE_MULTIPLIER：激增倍率阈值（默认：3）
#    - SURGE_ABSOLUTE_QPS：激增绝对阈值（QPS），默认：20
#    - DROP_MULTIPLIER：骤降倍率阈值（默认：0.1）
#    - BASELINE_MIN_QPS：基线最低 QPS，低于该值不判为骤降（默认：5）

apiVersion: 1

groups:
  - orgId: 1
    name: Customer MO TPS Alerts
    folder: Business-MO-TPS
    interval: 1m
    rules:
      # ================================ TPS 激增 ================================
      - uid: mo_tps_surge
        title: MOTpsSurge
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                # 5m 瞬时速率 vs 1h 平均速率基线，按 (name, appName,cId,appId) 聚合
                (
                  sum by(name, appName,cId,appId)(rate(customer_mo_req_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m]))
                  >
                  3 * sum by(name, appName,cId,appId)(rate(customer_mo_req_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m] offset 1h))
                )
                and (
                  sum by(name, appName,cId,appId)(rate(customer_mo_req_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m])) > 20
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "客户{{name}}-{{cId}} 应用{{appName}}-{{appId}} TPS 激增"
              maxDataPoints: 43200
              range: true
              refId: A
          # 在 A 与 C 之间新增两个查询用于在 description 展示详细数据
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName,cId,appId)(rate(customer_mo_req_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m]))
              interval: ""
              intervalMs: 1000
              instant: true
              legendFormat: "客户{{name}}-{{cId}} 应用{{appName}}-{{appId}} 当前QPS"
              maxDataPoints: 43200
              range: false
              refId: B
          - refId: E
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              reducer: last
              settings:
                mode: ""
              type: reduce
              refId: E
          - refId: D
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(name, appName,cId,appId)(rate(customer_mo_req_total{cId=~".*", name=~".*", appId=~".*", appName=~".*"}[5m] offset 1h))
              interval: ""
              intervalMs: 1000
              instant: true
              legendFormat: "客户{{name}}-{{cId}} 应用{{appName}}-{{appId}} 基线QPS(1h)"
              maxDataPoints: 43200
              range: false
              refId: D
          - refId: F
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: D
              reducer: last
              settings:
                mode: ""
              type: reduce
              refId: F
          - refId: Z
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              settings:
                mode: ""
              type: reduce
              refId: Z
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [1]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [Z]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: Z
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 5m
        annotations:
          summary: "客户{{ $labels.name }}-{{ $labels.cId }} 应用{{ $labels.appName }}-{{ $labels.appId }} TPS 激增"
          description: |
            当前5m QPS：{{ $values.E.Value | printf "%.2f" }}；基线(1h)QPS：{{ $values.F.Value | printf "%.2f" }}。
        labels:
          severity: warning
          category: business-mo-tps
          alert_type: tps_surge
