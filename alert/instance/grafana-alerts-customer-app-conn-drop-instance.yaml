# Grafana 客户侧应用连接数下降未恢复告警配置 (Prometheus 数据源)
# 使用说明：
# 1) 将 prometheus 替换为你的 Prometheus 数据源 UID（Grafana -> 数据源 -> Prometheus -> UID）
# 2) 将本文件放到 Grafana provisioning 目录（如 /etc/grafana/provisioning/alerting/），并重启/重新加载 Grafana
# 3) 告警会出现在 "Business-App-Connections" 文件夹下
# 4) 如需通过环境变量定制阈值，可在 Grafana 容器/服务中设置下述变量，或直接在本文件中替换：
#    - MIN_BASELINE_CONN: 基线连接数，低于该值不触发（默认：10）
#    - MIN_DROP_ABS: 绝对下降阈值，单位：连接数（默认：1）
#    - MIN_DROP_RATIO_PCT: 相对下降阈值，单位：百分比%（默认：0，即不限制）
#    - EVAL_FROM_SECONDS: 评估回看秒数（默认：180 秒）
#
# 变更说明：
# - 新增“断联前的当前连接数统计（PRE）”与“恢复后的当前连接数统计（POST）”
# - 采样频率为每 30 秒（仅作用于新增统计查询，避免影响原有告警判断）
# - 在通知注解中展示统计值与时间戳：使用 $values.PRE.Value/$values.PRE.Time 与 $values.POST.Value/$values.POST.Time

apiVersion: 1

groups:
  - orgId: 1
    name: 客户应用连接告警
    folder: 业务-客户-应用连接
    interval: 1m
    rules:
      - uid: app_conn_drop_not_recovered_1m
        title: 客户应用连接在5分钟内下降
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                # 按分钟检测断连：前两次检测为0，且再之前三次均>0
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 1m
                  ) == bool 0)
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 2m
                  ) == bool 0)
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 3m
                  ) > bool 0)
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 4m
                  ) > bool 0)
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 5m
                  ) > bool 0)
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "客户名称:{{name}} 客户id :{{cId}} 客户应用名称:{{appName}} 客户应用id:{{appId}} 断连模式匹配"
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0.5]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [B]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

          # PRE_RAW: 断联前（最后一次非零）连接数采样，选取 offset 3m 对应样本
          - refId: PRE_RAW
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                sum by (name, appName,cId,appId) (
                  online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 3m
                )
              interval: "30s"
              intervalMs: 30000
              legendFormat: "断联前连接数(3m) 客户名称:{{name}} 客户id :{{cId}} 客户应用名称:{{appName}} 客户应用id:{{appId}}"
              maxDataPoints: 43200
              range: true
              refId: PRE_RAW

          # PRE: 将 PRE_RAW 归约为单值（last），以便在注解中引用值与时间戳
          - refId: PRE
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: PRE_RAW
              reducer: last
              type: reduce
            intervalMs: 30000
            maxDataPoints: 43200
            refId: PRE

        noDataState: OK
        execErrState: Error
        for: 0m
        annotations:
          summary: 客户名称:{{ $labels.name }} 客户id :{{ $labels.cId }} 客户应用名称:{{ $labels.appName }} 客户应用id:{{ $labels.appId }} ，触发断连告警
          description: |
            【连接数记录】断联前连接数={{ $values.PRE.Value }}，时间戳={{ $values.PRE.Time }}


        labels:
          severity: warning
          category: business-app-connections
          alert_type: connection_drop

      - uid: app_conn_recover_notice_1m
        title: 客户应用连接在5分钟内恢复
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                # 恢复逻辑：最近三次>0，且再之前两次为0
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 1m
                  ) > bool 0)
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 2m
                  ) > bool 0)
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 3m
                  ) > bool 0)
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 4m
                  ) == bool 0)
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 5m
                  ) == bool 0)
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "客户名称:{{name}} 客户id :{{cId}} 客户应用名称:{{appName}} 客户应用id:{{appId}} 恢复模式匹配"
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0.5]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [B]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

          # POST_RAW: 恢复后的当前连接数（不加 offset，即当前时刻）
          - refId: POST_RAW
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                sum by (name, appName,cId,appId) (
                  online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                )
              interval: "30s"
              intervalMs: 30000
              legendFormat: "恢复后连接数 客户名称:{{name}} 客户id :{{cId}} 客户应用名称:{{appName}} 客户应用id:{{appId}}"
              maxDataPoints: 43200
              range: true
              refId: POST_RAW

          # POST: 将 POST_RAW 归约为单值（last），以便在注解中引用值与时间戳
          - refId: POST
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: POST_RAW
              reducer: last
              type: reduce
            intervalMs: 30000
            maxDataPoints: 43200
            refId: POST

        noDataState: OK
        execErrState: Error
        for: 0m
        annotations:
          summary: 客户名称:{{ $labels.name }} 客户id :{{ $labels.cId }} 客户应用名称:{{ $labels.appName }} 客户应用id:{{ $labels.appId }} 满足“最近3次>0且再之前2次=0”，发送恢复连接通知
          description: |
            【连接数记录】恢复后连接数={{ $values.POST.Value }}，时间戳={{ $values.POST.Time }}
        labels:
          severity: info
          category: business-app-connections
          alert_type: connection_recovered

      - uid: customer_login_failure_count_high_1m
        title: 客户登录失败次数1分钟内偏高
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                sum by(appId) ( increase(customer_login_total{appId=~".*", reason!="连接成功"}[1m]) )
              interval: ""
              intervalMs: 1000
              instant: true
              range: false
              refId: A
          - refId: C
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [5]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 3m
        annotations:
          summary: "客户{{ $labels.appId }}每分钟登录失败数超过5并持续3分钟"
          description: |
            客户登录失败的数值检测：每分钟失败次数超过5次，并持续3分钟后触发告警
        labels:
          severity: warning
          category: business-app-connections
          alert_type: failure_count_high
