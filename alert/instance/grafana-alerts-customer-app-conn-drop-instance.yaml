# Grafana 客户侧应用连接数下降未恢复告警配置 (Prometheus 数据源)
# 使用说明：
# 1) 将 P1809F7CD0C75ACF3 替换为你的 Prometheus 数据源 UID（Grafana -> 数据源 -> Prometheus -> UID）
# 2) 将本文件放到 Grafana provisioning 目录（如 /etc/grafana/provisioning/alerting/），并重启/重新加载 Grafana
# 3) 告警会出现在 "Business-App-Connections" 文件夹下
# 4) 如需通过环境变量定制阈值，可在 Grafana 容器/服务中设置下述变量，或直接在本文件中替换：
#    - MIN_BASELINE_CONN: 基线连接数，低于该值不触发（默认：10）
#    - MIN_DROP_ABS: 绝对下降阈值，单位：连接数（默认：1）
#    - MIN_DROP_RATIO_PCT: 相对下降阈值，单位：百分比%（默认：0，即不限制）
#    - EVAL_FROM_SECONDS: 评估回看秒数（默认：180 秒）

apiVersion: 1

groups:
  - orgId: 1
    name: Customer App Connection Alerts
    folder: Business-Customer-App-Connections
    interval: 1m
    rules:
      - uid: app_conn_drop_not_recovered_1m
        title: CustomerAppConnectionsDrop5mPattern
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                # 按分钟检测断连：前两次检测为0，且再之前三次均>0
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 1m
                  ) == 0) bool
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 2m
                  ) == 0) bool
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 3m
                  ) > 0) bool
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 4m
                  ) > 0) bool
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 5m
                  ) > 0) bool
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "{{name}}-{{cId}}, {{appName}}-{{appId}} 断连模式匹配"
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0.5]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [B]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

        noDataState: OK
        execErrState: Error
        for: 0m
        annotations:
          summary: 客户{{ $labels.name }}-{{ $labels.cId }} 应用{{ $labels.appName }}-{{ $labels.appId }}满足“前2次为0且再之前3次>0”，触发断连告警
          description: |
            【故障影响】相对于当前时间点，前两次连续检测结果等于0，且这两次之前的三次检测结果都大于0，触发断连告警
        labels:
          severity: warning
          category: business-app-connections
          alert_type: connection_drop

      - uid: app_conn_recover_notice_1m
        title: CustomerAppConnectionsRecover5mPattern
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                # 恢复逻辑：最近三次>0，且再之前两次为0
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 1m
                  ) > 0) bool
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 2m
                  ) > 0) bool
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 3m
                  ) > 0) bool
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 4m
                  ) == 0) bool
                )
                *
                (
                  (sum by (name, appName,cId,appId) (
                    online_customer_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"} offset 5m
                  ) == 0) bool
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "{{name}}-{{cId}}, {{appName}}-{{appId}} 恢复模式匹配"
              maxDataPoints: 43200
              range: true
              refId: A
          - refId: B
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              reducer: last
              type: reduce
              intervalMs: 1000
              maxDataPoints: 43200
              refId: B
          - refId: C
            relativeTimeRange:
              from: 600
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [0.5]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [B]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: B
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold

        noDataState: OK
        execErrState: Error
        for: 0m
        annotations:
          summary: 客户{{ $labels.name }}-{{ $labels.cId }} 应用{{ $labels.appName }}-{{ $labels.appId }}满足“最近3次>0且再之前2次=0”，发送恢复连接通知
          description: |
            【恢复说明】相对于当前时间点，连接数连续三次检测结果大于0，且这三次检测之前的两次检测结果等于0，发送恢复连接通知
        labels:
          severity: info
          category: business-app-connections
          alert_type: connection_recovered

      - uid: customer_login_failure_count_high_1m
        title: CustomerLoginFailureCountHigh1m
        condition: C
        data:
          - refId: A
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: P1809F7CD0C75ACF3
            model:
              datasource:
                type: prometheus
                uid: P1809F7CD0C75ACF3
              editorMode: code
              expr: |
                sum by(appId) ( increase(customer_login_total{appId=~".*", reason!="连接成功"}[1m]) )
              interval: ""
              intervalMs: 1000
              instant: true
              range: false
              refId: A
          - refId: C
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: __expr__
            model:
              conditions:
                - evaluator:
                    params: [5]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [A]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              expression: A
              intervalMs: 1000
              maxDataPoints: 43200
              refId: C
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 3m
        annotations:
          summary: "客户{{ $labels.appId }}每分钟登录失败数超过5并持续3分钟"
          description: |
            客户登录失败的数值检测：每分钟失败次数超过5次，并持续3分钟后触发告警
        labels:
          severity: warning
          category: business-customer-login
          alert_type: failure_count_high
