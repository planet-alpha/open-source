# Grafana 供应商应用连接数与 total 不相等持续 2 分钟告警 (Prometheus 数据源)
# 使用说明：
# 1) 将 ${DS_PROMETHEUS_UID} 替换为你的 Prometheus 数据源 UID（Grafana -> 数据源 -> Prometheus -> UID）
# 2) 将本文件放到 Grafana provisioning 目录（如 /etc/grafana/provisioning/alerting/），并重启/重新加载 Grafana
# 3) 告警会出现在 "Business-Supplier-App-Connections" 文件夹下
# 4) 触发逻辑与参数：
#    - 触发条件：abs( sum by (name, appName)(online_supplier_app{…实际…}) - avg by (name, appName)(online_supplier_app{…total…}) ) > 0 持续 2m
#    - 评估窗口：EVAL_FROM_SECONDS（默认 180s），仅用于注解内“三点数据”展示
#    - 提示：如 total 的标签值固定，建议精确匹配；avg by 用于去重，亦可换为 max/min
#    - 评估频率：由 groups.interval 控制（默认 1m），配合 for: 2m 实现“第三分钟触发”
# 环境变量：
#    - EVAL_FROM_SECONDS: 评估回看秒数（默认：180 秒）

apiVersion: 1

groups:
  - orgId: 1
    name: Supplier App Connection Alerts
    folder: Business-Supplier-App-Connections
    interval: 1m
    rules:
      # 触发条件状态机：
      # - 先连续 3 分钟“等于” total（评估间隔为 1m，共 3 个评估点）
      # - 紧接着连续 2 分钟“不等于” total
      # 满足以上序列后触发告警
      - uid: supplier_app_conn_drop_alert
        title: SupplierAppConnectionsDropAlert
        condition: E
        data:
          # A: 实际连接数（按 name, appName 聚合）
          - refId: A
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                (
                  max by (name, appName,cId,appId) (
                    online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                  )
                  and on (name, appName, cId, appId)
                  (
                    max_over_time(
                      max by (name, appName,cId,appId) (
                        online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                      )[10m:1m]
                    ) > bool 0
                  )
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "实际 max ({{name}}-{{cId}}, {{appName}}-{{appId}})"
              maxDataPoints: 43200
              range: true
              refId: A

          # B: total 基线（按 name, appName 归并去重，用 avg）
          - refId: B
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                avg by (name, appName,cId,appId) (
                  online_supplier_app_total{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*", total=~".*"} > 0
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "基线 total avg ({{name}}, {{appName}})"
              maxDataPoints: 43200
              range: true
              refId: B
          - refId: C
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: abs($A - $B)
              type: math
            intervalMs: 1000
            maxDataPoints: 43200

          - refId: ZE
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                (
                  max_over_time(
                    (
                      abs(
                        (
                          max by (name, appName,cId,appId) (
                            online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                          )
                          and on (name, appName, cId, appId)
                          (
                            max_over_time(
                              max by (name, appName,cId,appId) (
                                online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                              )[10m:1m]
                            ) > bool 0
                          )
                        )
                        - 
                        avg by (name, appName,cId,appId) (
                          online_supplier_app_total{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*", total=~".*"} > 0
                        )
                      )
                    )[3m:1m] offset 2m
                  ) == bool 0
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "3m等于判定 ({{name}}-{{cId}}, {{appName}}-{{appId}})"
              maxDataPoints: 43200
              range: true

          - refId: ZN
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                (
                  min_over_time(
                    (
                      abs(
                        (
                          max by (name, appName,cId,appId) (
                            online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                          )
                          and on (name, appName, cId, appId)
                          (
                            max_over_time(
                              max by (name, appName,cId,appId) (
                                online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                              )[10m:1m]
                            ) > bool 0
                          )
                        )
                        - 
                        avg by (name, appName,cId,appId) (
                          online_supplier_app_total{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*", total=~".*"} > 0
                        )
                      )
                    )[2m:1m]
                  ) > bool 0
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "2m不等于判定 ({{name}}-{{cId}}, {{appName}}-{{appId}})"
              maxDataPoints: 43200
              range: true

          - refId: Z
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: $ZE && $ZN
              type: math
            intervalMs: 1000
            maxDataPoints: 43200

          # 注解中直接使用 $values.A.Value / $values.B.Value，无需额外 reduce

          # R: Z 的归约（last），供 E 阈值判断使用
          - refId: R
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: Z
              type: reduce
              reducer: last
            intervalMs: 1000
            maxDataPoints: 43200

          # E: 阈值判断（> 0）
          - refId: E
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: __expr__
            model:
              expression: R
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [R]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              intervalMs: 1000
              maxDataPoints: 43200
              refId: E
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 0m
        annotations:
          summary: 供应商名称:{{ $labels.name }} 供应商id :{{ $labels.cId }} 供应商应用名称:{{ $labels.appName }} 供应商应用id:{{ $labels.appId }} 断连
          description: |
            【当前值】 实际连接数={{ $values.A.Value }}，标准连接数={{ $values.B.Value }}，差值={{ $values.C.Value }}
            【判定】 ZE(3m等于)={{ $values.ZE.Value }}，ZN(2m不等于)={{ $values.ZN.Value }}
        labels:
          severity: warning
          category: business-supplier-app-connections
          alert_type: connection_drop

      # 恢复通知状态机：
      # - 先连续 2 分钟“不等于” total（评估间隔为 1m，共 2 个评估点）
      # - 紧接着连续 3 分钟“等于” total
      # 满足以上序列后触发“连接恢复”通知
      - uid: supplier_app_conn_recovered
        title: SupplierAppConnectionsRecoveredAlert
        condition: E
        data:
          # A: 实际连接数（按 name, appName 聚合）
          - refId: A
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                (
                  max by (name, appName,cId,appId) (
                    online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                  )
                  and on (name, appName, cId, appId)
                  (
                    max_over_time(
                      max by (name, appName,cId,appId) (
                        online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                      )[10m:1m]
                    ) > bool 0
                  )
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "实际 max ({{name}}-{{cId}}, {{appName}}-{{appId}})"
              maxDataPoints: 43200
              range: true
              refId: A

          # B: total 基线（按 name, appName 归并去重，用 avg）
          - refId: B
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                avg by (name, appName,cId,appId) (
                  online_supplier_app_total{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*", total=~".*"} > 0
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "基线 total avg ({{name}}, {{appName}})"
              maxDataPoints: 43200
              range: true
              refId: B
          - refId: C
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: abs($A - $B)
              type: math
            intervalMs: 1000
            maxDataPoints: 43200

          - refId: ZRE_NE
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                (
                  min_over_time(
                    (
                      abs(
                        (
                          max by (name, appName,cId,appId) (
                            online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                          )
                          and on (name, appName, cId, appId)
                          (
                            max_over_time(
                              max by (name, appName,cId,appId) (
                                online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                              )[10m:1m]
                            ) > bool 0
                          )
                        )
                        - 
                        avg by (name, appName,cId,appId) (
                          online_supplier_app_total{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*", total=~".*"} > 0
                        )
                      )
                    )[2m:1m] offset 3m
                  ) > bool 0
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "恢复阶段NE(2m不等于) ({{name}}-{{cId}}, {{appName}}-{{appId}})"
              maxDataPoints: 43200
              range: true

          - refId: ZRE_EQ
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: prometheus
            model:
              datasource:
                type: prometheus
                uid: prometheus
              editorMode: code
              expr: |
                (
                  max_over_time(
                    (
                      abs(
                        (
                          max by (name, appName,cId,appId) (
                            online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                          )
                          and on (name, appName, cId, appId)
                          (
                            max_over_time(
                              max by (name, appName,cId,appId) (
                                online_supplier_app{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*"}
                              )[10m:1m]
                            ) > bool 0
                          )
                        )
                        - 
                        avg by (name, appName,cId,appId) (
                          online_supplier_app_total{cId=~".*", name=~".*", appId=~".*", appName=~".*", protocol=~".*", total=~".*"} > 0
                        )
                      )
                    )[3m:1m]
                  ) == bool 0
                )
              interval: ""
              intervalMs: 1000
              legendFormat: "恢复阶段EQ(3m等于) ({{name}}-{{cId}}, {{appName}}-{{appId}})"
              maxDataPoints: 43200
              range: true

          - refId: ZR
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: $ZRE_NE && $ZRE_EQ
              type: math
            intervalMs: 1000
            maxDataPoints: 43200

          # 注解中直接使用 $values.A.Value / $values.B.Value，无需额外 reduce

          # R: ZR 的归约（last），供 E 阈值判断使用
          - refId: R
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: __expr__
            model:
              datasource:
                type: __expr__
                uid: __expr__
              expression: ZR
              type: reduce
              reducer: last
            intervalMs: 1000
            maxDataPoints: 43200

          # E: 阈值判断（> 0）
          - refId: E
            relativeTimeRange:
              from: 180
              to: 0
            datasourceUid: __expr__
            model:
              expression: R
              conditions:
                - evaluator:
                    params: [0]
                    type: gt
                  operator:
                    type: and
                  query:
                    params: [R]
                  reducer:
                    type: last
                  type: query
              datasource:
                type: __expr__
                uid: __expr__
              intervalMs: 1000
              maxDataPoints: 43200
              refId: E
              type: threshold
        noDataState: OK
        execErrState: Error
        for: 0m
        annotations:
          summary: 供应商名称:{{ $labels.name }} 供应商id :{{ $labels.cId }} 供应商应用名称:{{ $labels.appName }} 供应商应用id:{{ $labels.appId }} 连接恢复
          description: |
            【当前值】 实际连接数={{ $values.A.Value }}，标准连接数={{ $values.B.Value }}，差值={{ $values.C.Value }}
            【判定】 ZRE_NE(2m不等于)={{ $values.ZRE_NE.Value }}，ZRE_EQ(3m等于)={{ $values.ZRE_EQ.Value }}
        labels:
          severity: info
          category: business-supplier-app-connections
          alert_type: connection_recovered
